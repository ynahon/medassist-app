name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

env:
  PROJECT_ID: ${{ secrets.GKE_PROJECT }}
  GKE_REGION: us-central1

jobs:
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.environment == 'dev'
    environment: dev

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        run: |
          VERSION_FILE="server/version.txt"
          CURRENT_VERSION=$(cat $VERSION_FILE)
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo $NEW_VERSION > $VERSION_FILE
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "Bumped version from $CURRENT_VERSION to $NEW_VERSION"

      - name: Commit version bump
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add server/version.txt
          git commit -m "Bump version to ${{ env.VERSION }} [skip ci]"
          git push

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY_DEV }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Database Migrations
        run: |
          # Run Drizzle migrations with explicit config
          echo "Length: ${#DATABASE_URL_DEV}"
          echo "${{ secrets.DATABASE_URL_DEV }}" | sed 's/./& /g'
          npx drizzle-kit push --config=drizzle.config.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_DEV }}

      - name: Configure Docker
        run: gcloud --quiet auth configure-docker gcr.io

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: medassist-cluster-dev
          location: ${{ env.GKE_REGION }}

      - name: Build and Push
        run: |
          echo "Building with version: $(cat server/version.txt)"
          docker build --no-cache --tag "gcr.io/$PROJECT_ID/medassist-api-dev:$GITHUB_SHA" .
          docker push "gcr.io/$PROJECT_ID/medassist-api-dev:$GITHUB_SHA"

      - name: Deploy to K8s (Dev)
        run: |
          cd k8s/overlays/dev
          kustomize edit set image gcr.io/PROJECT_ID/IMAGE=gcr.io/$PROJECT_ID/medassist-api-dev:$GITHUB_SHA
          kubectl apply -k .
          # Wait for rollout - don't fail CI if it times out (zero-downtime maintained)
          kubectl rollout status deployment/medassist-dev -n medassist-dev --timeout=10m || echo "Rollout still in progress - old pod remains running"

  deploy-prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY_PROD }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Database Migrations
        run: |
          # Run Drizzle migrations with explicit config
          npx drizzle-kit push --config=drizzle.config.ts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}

      - name: Configure Docker
        run: gcloud --quiet auth configure-docker gcr.io

      - name: Get GKE Credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: medassist-cluster-prod
          location: ${{ env.GKE_REGION }}

      - name: Build and Push
        run: |
          docker build --tag "gcr.io/$PROJECT_ID/medassist-api:$GITHUB_SHA" .
          docker push "gcr.io/$PROJECT_ID/medassist-api:$GITHUB_SHA"

      - name: Deploy to K8s (Prod)
        run: |
          cd k8s/overlays/prod
          kustomize edit set image gcr.io/PROJECT_ID/IMAGE=gcr.io/$PROJECT_ID/medassist-api:$GITHUB_SHA
          kubectl apply -k .
          kubectl rollout status deployment/medassist-prod -n medassist-prod --timeout=10m